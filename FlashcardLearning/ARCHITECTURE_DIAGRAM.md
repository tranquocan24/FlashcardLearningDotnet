# ??? ARCHITECTURE DIAGRAM

## 3-Layer Architecture Overview

```
???????????????????????????????????????????????????????????????????????????
?                          CLIENT (Browser/Mobile)                         ?
???????????????????????????????????????????????????????????????????????????
                                 ? HTTP Request/Response
                                 ?
???????????????????????????????????????????????????????????????????????????
?                      PRESENTATION LAYER                                  ?
?                                                                           ?
?  ???????????????????????????????????????????????????????????????????   ?
?  ?                     CONTROLLERS                                  ?   ?
?  ?                                                                  ?   ?
?  ?  ????????????????  ????????????????  ????????????????         ?   ?
?  ?  ?   Decks      ?  ?   Folders    ?  ?  Flashcards  ?         ?   ?
?  ?  ?  Controller  ?  ?  Controller  ?  ?  Controller  ?  ...    ?   ?
?  ?  ????????????????  ????????????????  ????????????????         ?   ?
?  ?         ?                  ?                  ?                  ?   ?
?  ?         ? Inject Service   ?                  ?                  ?   ?
?  ????????????????????????????????????????????????????????????????????   ?
?            ?                  ?                  ?                       ?
????????????????????????????????????????????????????????????????????????????
             ?                  ?                  ?
             ?                  ?                  ?
????????????????????????????????????????????????????????????????????????????
?                      BUSINESS LOGIC LAYER                                 ?
?                                                                            ?
?  ???????????????????????????????????????????????????????????????????    ?
?  ?                       SERVICES                                   ?    ?
?  ?                                                                  ?    ?
?  ?  ????????????????  ????????????????  ????????????????         ?    ?
?  ?  ?    Deck      ?  ?    Folder    ?  ?  Flashcard   ?         ?    ?
?  ?  ?   Service    ?  ?   Service    ?  ?   Service    ?  ...    ?    ?
?  ?  ????????????????  ????????????????  ????????????????         ?    ?
?  ?         ?                  ?                  ?                  ?    ?
?  ?         ? Inject Repository?                  ?                  ?    ?
?  ?         ?                  ?                  ?                  ?    ?
?  ?  • Business Logic          ?                  ?                  ?    ?
?  ?  • Validation             ?                  ?                  ?    ?
?  ?  • Authorization          ?                  ?                  ?    ?
?  ?  • DTO Mapping            ?                  ?                  ?    ?
?  ????????????????????????????????????????????????????????????????????    ?
?            ?                  ?                  ?                        ?
?????????????????????????????????????????????????????????????????????????????
             ?                  ?                  ?
             ?                  ?                  ?
?????????????????????????????????????????????????????????????????????????????
?                      DATA ACCESS LAYER                                     ?
?                                                                             ?
?  ???????????????????????????????????????????????????????????????????     ?
?  ?                    REPOSITORIES                                  ?     ?
?  ?                                                                  ?     ?
?  ?  ????????????????  ????????????????  ????????????????         ?     ?
?  ?  ?    Deck      ?  ?   Folder     ?  ?  Flashcard   ?         ?     ?
?  ?  ?  Repository  ?  ?  Repository  ?  ?  Repository  ?  ...    ?     ?
?  ?  ????????????????  ????????????????  ????????????????         ?     ?
?  ?         ?                  ?                  ?                  ?     ?
?  ?         ???????????????????????????????????????                  ?     ?
?  ?                            ?                                     ?     ?
?  ?                  ?????????????????????                          ?     ?
?  ?                  ?  Generic Repository?                          ?     ?
?  ?                  ?????????????????????                          ?     ?
?  ?                            ?                                     ?     ?
?  ?  • CRUD Operations         ?                                     ?     ?
?  ?  • EF Core Queries         ?                                     ?     ?
?  ?  • Include/Join            ?                                     ?     ?
?  ????????????????????????????????????????????????????????????????????     ?
?                               ?                                            ?
??????????????????????????????????????????????????????????????????????????????
                                ?
                                ?
??????????????????????????????????????????????????????????????????????????????
?                      DATABASE LAYER                                         ?
?                                                                              ?
?  ???????????????????????????????????????????????????????????????????????  ?
?  ?                       SQL SERVER                                     ?  ?
?  ?                                                                      ?  ?
?  ?  ???????????  ???????????  ????????????  ????????????  ???????????  ?
?  ?  ?  Users  ?  ?  Decks  ?  ? Folders  ?  ?Flashcards?  ?Sessions??  ?
?  ?  ???????????  ???????????  ????????????  ????????????  ???????????  ?
?  ?                                                                      ?  ?
?  ????????????????????????????????????????????????????????????????????????  ?
?                                                                              ?
????????????????????????????????????????????????????????????????????????????????
```

---

## Request Flow Example: Create Deck

```
1. Client sends POST /api/decks
   ??> JSON: { title: "IELTS", description: "...", folderId: "..." }

2. DecksController receives request
   ??> Extract current user ID from JWT claims
   ??> Call: _deckService.CreateDeckAsync(request, userId)
   ??> Return: CreatedAtAction with DeckResponse

3. DeckService processes business logic
   ??> Validate: Check if folder exists (via FolderRepository)
   ??> Validate: Check if user owns the folder
   ??> Create: New Deck entity with Guid.NewGuid()
   ??> Call: _deckRepository.AddAsync(deck)
   ??> Map: Deck entity ? DeckResponse DTO

4. DeckRepository saves to database
   ??> DbSet.AddAsync(deck)
   ??> DbContext.SaveChangesAsync()
   ??> Return: Saved deck entity

5. Response flows back
   ??> Controller ? Client: 201 Created with DeckResponse JSON
```

---

## Dependency Injection Container

```
??????????????????????????????????????????????????????
?              Program.cs (DI Container)              ?
??????????????????????????????????????????????????????
?                                                     ?
?  DbContext:                                         ?
?    ? AddDbContext<AppDbContext>()                 ?
?                                                     ?
?  Repositories (AddScoped):                          ?
?    ? IRepository<T> ? Repository<T>               ?
?    ? IDeckRepository ? DeckRepository              ?
?    ? IFolderRepository ? FolderRepository          ?
?    ? IUserRepository ? UserRepository (TODO)       ?
?    ? IFlashcardRepository ? FlashcardRepository    ?
?                                                     ?
?  Services (AddScoped):                              ?
?    ? IDeckService ? DeckService                    ?
?    ? IFolderService ? FolderService (TODO)         ?
?    ? IUserService ? UserService (TODO)             ?
?    ? IAuthService ? AuthService (TODO)             ?
?                                                     ?
?  Controllers (AddControllers):                      ?
?    ? Auto-registered                               ?
?                                                     ?
??????????????????????????????????????????????????????
```

---

## Class Relationships

```
????????????????????????
?   IRepository<T>     ?
?   (Generic)          ?
????????????????????????
           ? inherits
           ?
????????????????????????
?  IDeckRepository     ?
?  (Specialized)       ?
????????????????????????
           ? implements
           ?
????????????????????????
?   DeckRepository     ?
?   (Concrete)         ?
????????????????????????
           ? injected into
           ?
????????????????????????
?    DeckService       ?
?  (Business Logic)    ?
????????????????????????
           ? injected into
           ?
????????????????????????
?   DecksController    ?
?   (HTTP Handler)     ?
????????????????????????
```

---

## Data Flow: Get Deck by ID

```
??????????     ????????????????     ???????????????     ????????????????     ????????????
? Client ???????DecksController??????? DeckService ???????DeckRepository??????? Database ?
??????????     ????????????????     ???????????????     ????????????????     ????????????
     ?                 ?                    ?                    ?                   ?
     ? GET /api/decks/?                    ?                    ?                   ?
     ?      {id}      ?                    ?                    ?                   ?
     ?                ?                    ?                    ?                   ?
     ?                ? GetDeckByIdAsync() ?                    ?                   ?
     ?                ??????????????????????                    ?                   ?
     ?                ?                    ?                    ?                   ?
     ?                ?                    ? GetDeckWithFlashcardsAsync(id)         ?
     ?                ?                    ??????????????????????                   ?
     ?                ?                    ?                    ?                   ?
     ?                ?                    ?                    ? SELECT * FROM ... ?
     ?                ?                    ?                    ?????????????????????
     ?                ?                    ?                    ?                   ?
     ?                ?                    ?                    ?????????????????????
     ?                ?                    ?                    ?   Deck Entity     ?
     ?                ?                    ??????????????????????                   ?
     ?                ?                    ?   Deck Entity      ?                   ?
     ?                ?                    ?                    ?                   ?
     ?                ?   Check Access     ?                    ?                   ?
     ?                ?   Map to DTO       ?                    ?                   ?
     ?                ??????????????????????                    ?                   ?
     ?                ?  DeckDetailResponse?                    ?                   ?
     ?                ?                    ?                    ?                   ?
     ??????????????????                    ?                    ?                   ?
     ?   200 OK       ?                    ?                    ?                   ?
     ?   + JSON       ?                    ?                    ?                   ?
```

---

## Benefits of This Architecture

### ?? Separation of Concerns
- **Controller**: HTTP handling only
- **Service**: Business logic only
- **Repository**: Data access only

### ?? Testability
- Mock repositories in service tests
- Mock services in controller tests
- No database needed for unit tests

### ?? Maintainability
- Changes isolated to specific layer
- Easy to add new features
- Clear code organization

### ?? Reusability
- Business logic can be reused
- Generic repository for all entities
- Services can call multiple repositories

### ?? Dependency Injection
- Loose coupling
- Easy to swap implementations
- Automatic lifetime management

---

## Code Example: Complete Flow

### 1. Controller (Thin)
```csharp
[HttpPost]
public async Task<ActionResult<DeckResponse>> CreateDeck(CreateDeckRequest request)
{
    var userId = GetCurrentUserId();
    var deck = await _deckService.CreateDeckAsync(request, userId);
    return CreatedAtAction(nameof(GetDeck), new { id = deck.Id }, deck);
}
```

### 2. Service (Business Logic)
```csharp
public async Task<DeckResponse> CreateDeckAsync(CreateDeckRequest request, Guid userId)
{
    // Validate folder
    if (request.FolderId.HasValue)
    {
        var folderExists = await _folderRepository.ExistsAsync(request.FolderId.Value);
        if (!folderExists) throw new InvalidOperationException("Folder not found");
    }
    
    // Create entity
    var deck = new Deck { ... };
    
    // Save to DB
    await _deckRepository.AddAsync(deck);
    
    // Map to DTO
    return new DeckResponse { ... };
}
```

### 3. Repository (Data Access)
```csharp
public async Task<Deck> AddAsync(Deck entity)
{
    await _dbSet.AddAsync(entity);
    await _context.SaveChangesAsync();
    return entity;
}
```

---

*This architecture ensures clean code, easy maintenance, and high testability!* ??
